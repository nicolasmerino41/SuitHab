---
title: "suitHab Design"
author: "Nico & Núria"
date: "2025-08-28"
output:
  pdf_document:
    toc: false
    toc_depth: 5
  html_document:
    theme: flatly
    toc: true
    toc_depth: 5
    number_sections: true
    toc_float:
      collapsed: false
    highlight: tango
  word_document:
    toc: false
    toc_depth: '5'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Framework

## Grid, climate, species, and metaweb

We consider a spatial grid of \(C\) cells, each with a scalar climate value in \([0,1]\). A regional pool of \(S\) species is endowed with:

- a climatic niche center and breadth, yielding a climate suitability indicator \(Z_s(c)\in\{0,1\}\),

- a metaweb of trophic links (directed pred\(\to\)prey), built from an allometric niche model,

- a basal flag (no prey required) vs consumer (at least one prey required).

A community in a cell assembles by the rule: a consumer persists only if at least one of its prey is present in that cell. There is no abundance; a species is either present or absent in a cell.

## From suitability to presence

Let \(Z_s(c)=1\) if climate is suitable to species \(s\) in cell \(c\), and 0 otherwise. After applying the trophic rule, presence is \(P_s(c)\in\{0,1\}\).

## Biotically Suitable Habitat (BSH)

For a species \(s\), define:

- **Climate area fraction**
$$
A_s \,=\, \frac{1}{C}\sum_{c=1}^{C} \mathbf{1}\{Z_s(c)=1\}
$$

- **Prey support *within* climate**

$$
p_s \,=\, \frac{\sum_c \mathbf{1}\{Z_s(c)=1 \wedge \text{(at least one prey of $s$ present in $c$)}\}}
{\sum_c \mathbf{1}\{Z_s(c)=1\}}\,,
$$

with the convention \(p_s=1\) for basal species and \(p_s=0\) if the denominator is 0.

- **BSH** (Biotically Suitable Habitat) is the fraction of grid cells that are both climatically suitable and biotically viable:
$$
\text{BSH}_s = A_s\,p_s
$$

BSH is a *fraction* (0–1) measured against the whole grid.

## Habitat loss scenarios

Habitat loss removes a fraction \(f\) of cells by a spatial rule:

- **Random:** uniform at random.

- **Clustered:** spatial clusters (e.g. BFS growth from seeds).

- **Hotspot:** rank cells by a prey-aware score (e.g. number of consumers with at least one climatically suitable prey) and remove the highest-scoring first.

**All quantities above are recomputed on the kept cells!!!!!!**

Let \((A_0, p_0)\) be the species values before loss and \((A_1, p_1)\) after loss; then
$$
\Delta BSH_s = A_1 p_1 - A_0 p_0
$$
is the change in BSH for species \(s\).

## Linear decomposition

Let's define midpoints \(\bar A = (A_0{+}A_1)/2\) and \(\bar p = (p_0{+}p_1)/2\). 

The symmetric (Shapley-like) decomposition for the linear outcome \(B=Ap\) is
$$
\Delta BSH_s
= \underbrace{\bar p\,\Delta A}_{\text{climate-only}}
+ \underbrace{\bar A\,\Delta p}_{\text{interaction-only}}
+ \underbrace{\text{synergy}}_{0\ \text{for }B=Ap}.
$$

Because \(B=Ap\) is bilinear, the residual (synergy) is exactly 0. In random loss, \(\Delta p\approx 0\) and almost all change is climate-only. When loss targets prey-rich suitable cells (hotspot), \(\Delta p<0\) and the interaction-only term becomes negative.

## Nonlinear viability (making synergy real)

Given management questions care about viability instead of area, we therefore define a nonlinear outcome
$$
V(A,p) \;=\; A\,\phi(p)
$$
with two options for \(\phi\):

- **Saturating:** \(\phi(p) = \frac{p}{p+h}\) with \(h>0\) (half-saturation).

- **Threshold:** \(\phi(p) = \mathbf{1}\{p\geq \rho\}\).

The same midpoint logic yields a symmetric attribution for any \(U\):
$$
\begin{aligned}
\Delta V_s &= V(A_1,p_1) - V(A_0,p_0),\\\\
\text{climate-only} &= V(A_1,\bar p) - V(A_0,\bar p),\\\\
\text{interaction-only} &= V(\bar A,p_1) - V(\bar A,p_0),\\\\
\text{synergy} &= \Delta V_s - (\text{climate-only}) - (\text{interaction-only}).
\end{aligned}
$$

When \(\phi\) is nonlinear, the residual is generally non-zero. Intuitively, synergy captures the compounding effect of losing prey support exactly where viable climate remains **(curvature + covariance)?**.

## What do the signs mean?

- **Climate-only** (<0): we removed climatically suitable cells for \(s\).
- **Interaction-only** (<0): in the suitable cells we kept, the *share* that are prey-supported decreased (e.g. hotspot removal of prey-rich suitable cells).
- **Synergy** \(\neq\) 0: because viability is nonlinear, coincident changes in \(A\) and \(p\) interact (they are not additive). Large negative synergy implies losses concentrate where \(\phi(p)\) is most sensitive.

For each species \(s\) with niche center \(\mu_s\) and breadth \(b_s\), the climatic suitability in cell \(c\) with climate value \(clim(c)\) is

\[
su_{s}(c) \;=\; \exp\!\left(-\,\frac{(clim(c)-\mu_s)^2}{2\,b_s^2}\right).
\]

Species \(s\) is considered climate-suitable in cell \(c\) if

\[
Z_{s,c} \;=\;
\begin{cases}
1, & su_{s}(c) \;\geq\; \tau, \\
0, & \text{otherwise}.
\end{cases}
\]

Define the mean BSH change under scenario \(X\) as \(\Delta B^{(X)}\),  
with \(X \in \{\text{random}, \text{clustered}, \text{hotspot}\}\).

- **Excess damage of clustered over random:**
\[
\Delta BSH_{\text{clust-rand}}
= \Delta BSH_{\text{clustered}} - \Delta BSH_{\text{random}}.
\]

- **Excess damage of hotspot over random:**
\[
\Delta BSH_{\text{hotspot-rand}}
= \Delta BSH_{\text{hotspot}} - \Delta BSH_{\text{random}}.
\]


